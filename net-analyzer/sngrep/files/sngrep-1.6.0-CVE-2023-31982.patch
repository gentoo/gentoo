From be410d0f6a9a3994448959581e5bd4a3b26fb7cd Mon Sep 17 00:00:00 2001
From: Kaian <kaian@irontec.com>
Date: Fri, 3 Mar 2023 12:49:17 +0100
Subject: [PATCH] capture: validate frame has at least IP header before
 assembly #431

---
 src/capture.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/src/capture.c b/src/capture.c
index 00570638..7145b50a 100644
--- a/src/capture.c
+++ b/src/capture.c
@@ -620,6 +620,15 @@ capture_packet_reasm_ip(capture_info_t *capinfo, const struct pcap_pkthdr *heade
     if (*caplen > MAX_CAPTURE_LEN)
         return NULL;
 
+    // Check frame has at least IP header length
+    if (ip_ver == 4 && header->caplen < sizeof(struct ip))
+        return NULL;
+
+#ifdef USE_IPV6
+    if (ip_ver == 6 && header->caplen < sizeof(struct ip6_hdr))
+        return NULL;
+#endif
+
     // If no fragmentation
     if (ip_frag == 0) {
         // Just create a new packet with given network data
