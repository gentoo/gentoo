# Copyright 2024-2026 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

# Autogenerated by pycargoebuild 0.15.1

EAPI=8

CRATES="
"

RUST_MIN_VER="1.85.0"

inherit cargo

DESCRIPTION="Unofficial GlobalProtect VPN client for Linux"
HOMEPAGE="https://github.com/yuezk/GlobalProtect-openconnect"

OPENCONNECT_COMMIT="0dcdff87db65daf692dc323732831391d595d98d"

SRC_URI="
	https://github.com/yuezk/GlobalProtect-openconnect/archive/v${PV}.tar.gz -> ${P}.gh.tar.gz
	https://gitlab.com/openconnect/openconnect/-/archive/${OPENCONNECT_COMMIT}/openconnect-${OPENCONNECT_COMMIT}.tar.bz2
"
if [[ ${PKGBUMPING} != ${PVR} ]]; then
	SRC_URI+="
		https://github.com/shuttie/globalprotect-openconnect-ebuild/releases/download/v${PV}/globalprotect-openconnect-${PV}-crates.tar.xz
	"
fi

S="${WORKDIR}/GlobalProtect-openconnect-${PV}"

LICENSE="GPL-3"
# Dependent crate licenses
LICENSE+="
	Apache-2.0 Apache-2.0-with-LLVM-exceptions BSD-2 BSD ISC MIT MPL-2.0
	Unicode-3.0
"
SLOT="0"
KEYWORDS="~amd64"

RDEPEND="
	app-arch/lz4:=
	app-crypt/p11-kit
	app-crypt/trousers
	dev-libs/json-parser
	dev-libs/openssl:=
	net-libs/gnutls:=
	net-libs/webkit-gtk:4.1=
	x11-libs/gtk+:3
"
DEPEND="${RDEPEND}"
BDEPEND="
	dev-build/autoconf
	dev-build/automake
	dev-build/libtool
	virtual/pkgconfig
"

QA_FLAGS_IGNORED="usr/bin/gp*"

src_unpack() {
	cargo_src_unpack
	# Place openconnect submodule source where build.rs expects it
	rmdir "${S}/crates/openconnect/deps/openconnect" 2>/dev/null
	mv "${WORKDIR}/openconnect-${OPENCONNECT_COMMIT}" \
		"${S}/crates/openconnect/deps/openconnect" || die
}

src_compile() {
	export RUSTFLAGS="${RUSTFLAGS} -l jsonparser -l tspi"
	cargo_src_compile -p gpauth -p gpclient -p gpservice
}

src_install() {
	for i in gpauth gpclient gpservice; do
		dobin "$(cargo_target_dir)/${i}"
	done
}
