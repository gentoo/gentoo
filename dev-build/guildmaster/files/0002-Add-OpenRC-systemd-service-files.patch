From dcb0802716e5afc574a8a05e9030d1fa66b161d6 Mon Sep 17 00:00:00 2001
Message-ID: <dcb0802716e5afc574a8a05e9030d1fa66b161d6.1764295572.git.sam@gentoo.org>
In-Reply-To: <a40447a74c41917643b7a5a28300c50f35b13388.1764295572.git.sam@gentoo.org>
References: <a40447a74c41917643b7a5a28300c50f35b13388.1764295572.git.sam@gentoo.org>
From: Sam James <sam@gentoo.org>
Date: Fri, 28 Nov 2025 02:05:02 +0000
Subject: [PATCH 2/2] Add OpenRC, systemd service files

I've only opted to install the systemd service file as while Gentoo policy
is to install such files (like for OpenRC) unconditionally, I'm not sure
other distributions expect the same, or what.
---
 guildmaster.confd   | 1 +
 guildmaster.initd   | 5 +++++
 guildmaster.service | 7 +++++++
 meson.build         | 6 ++++++
 4 files changed, 19 insertions(+)
 create mode 100644 guildmaster.confd
 create mode 100644 guildmaster.initd
 create mode 100644 guildmaster.service

diff --git a/guildmaster.confd b/guildmaster.confd
new file mode 100644
index 0000000..3192f17
--- /dev/null
+++ b/guildmaster.confd
@@ -0,0 +1 @@
+#GUILDMASTER_OPTS=""
diff --git a/guildmaster.initd b/guildmaster.initd
new file mode 100644
index 0000000..b2bf171
--- /dev/null
+++ b/guildmaster.initd
@@ -0,0 +1,5 @@
+#!/sbin/openrc-run
+command="/usr/bin/gm"
+command_args="${GUILDMASTER_OPTS}"
+command_background=true
+pidfile="/run/${RC_SVCNAME}.pid"
diff --git a/guildmaster.service b/guildmaster.service
new file mode 100644
index 0000000..d76a6bb
--- /dev/null
+++ b/guildmaster.service
@@ -0,0 +1,7 @@
+[Service]
+Type=exec
+ExecStart=/usr/bin/gm
+
+[Install]
+WantedBy=multi-user.target
+
diff --git a/meson.build b/meson.build
index 83d2123..c206839 100644
--- a/meson.build
+++ b/meson.build
@@ -9,6 +9,7 @@ project(
 
 fuse_dep = dependency('fuse3')
 udev_dep = dependency('udev', required: false)
+systemd_dep = dependency('systemd', required: false)
 
 dependencies = [fuse_dep]
 
@@ -26,6 +27,11 @@ gm_exe = executable(
     install: true,
 )
 
+install_data(
+    ['guildmaster.service'],
+    install_dir: join_paths(systemd_dep.get_variable('systemdsystemunitdir')),
+)
+
 install_data(
     ['cuse-guild.rules'],
     install_dir: join_paths(udev_dep.get_variable('udevdir'), 'rules.d'),
-- 
2.52.0

